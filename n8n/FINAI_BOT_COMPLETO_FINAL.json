{
  "name": "FINAI BOT - SISTEMA COMPLETO COM CONTROLE DE STATUS",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "webhook",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [-6300, -560],
      "id": "4d0eb93b-80e6-4a19-9b24-092c8d036712",
      "name": "Webhook Principal",
      "webhookId": "11201585-7dab-47ca-9aec-f1643297e0b4"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "payment-webhook",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [-6300, -200],
      "id": "payment-webhook-node",
      "name": "Webhook Pagamentos",
      "webhookId": "payment-webhook-id"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "status-check",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [-6300, 160],
      "id": "status-check-webhook",
      "name": "Webhook Verifica√ß√£o Status",
      "webhookId": "status-check-webhook-id"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "6afb9844-8c32-48cc-b2d0-fd4cf5fb2a7e",
              "name": "session",
              "value": "={{ $json.body.session }}",
              "type": "string"
            },
            {
              "id": "be6a3084-e016-41bd-9535-982d7f292916",
              "name": "event",
              "value": "={{ $json.body.event }}",
              "type": "string"
            },
            {
              "id": "892d1e0e-d6d9-4aca-a98e-75b8125a0893",
              "name": "chatId",
              "value": "={{ $json.body.payload.from }}",
              "type": "string"
            },
            {
              "id": "da3fcefa-bc50-4167-bae1-8238821da2e6",
              "name": "pushName",
              "value": "={{ $json.body.payload._data.Info.PushName }}",
              "type": "string"
            },
            {
              "id": "e0ce4b8b-cf84-42dd-b1f6-9a621d167151",
              "name": "payload_id",
              "value": "={{ $json.body.payload.id }}",
              "type": "string"
            },
            {
              "id": "6bf25c6f-69c9-43fa-9e63-cf463e1bb778",
              "name": "message",
              "value": "={{ $json.body.payload.body }}",
              "type": "string"
            },
            {
              "id": "0b269e48-9034-4c08-8f15-28224af8400c",
              "name": "fromMe",
              "value": "={{ $json.body.payload.fromMe }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [-6040, -560],
      "id": "75a41cac-c4e7-44e1-886f-5251f781a12b",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "payment-type",
              "name": "type",
              "value": "={{ $json.body.type }}",
              "type": "string"
            },
            {
              "id": "payment-client",
              "name": "client",
              "value": "={{ $json.body.client }}",
              "type": "object"
            },
            {
              "id": "payment-message",
              "name": "message",
              "value": "={{ $json.body.message }}",
              "type": "string"
            },
            {
              "id": "payment-data",
              "name": "payment",
              "value": "={{ $json.body.payment }}",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [-6040, -200],
      "id": "payment-edit-fields",
      "name": "Edit Payment Fields"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "status-phone",
              "name": "phone",
              "value": "={{ $json.body.phone }}",
              "type": "string"
            },
            {
              "id": "status-action",
              "name": "action",
              "value": "={{ $json.body.action }}",
              "type": "string"
            },
            {
              "id": "status-client",
              "name": "client",
              "value": "={{ $json.body.client }}",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [-6040, 160],
      "id": "status-edit-fields",
      "name": "Edit Status Fields"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json['event'] }}",
                    "rightValue": "message",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "d63cc31b-da08-49e1-b041-f09743aba548"
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [-5760, -560],
      "id": "afca0df0-0818-4280-ab08-1a21431cc5a6",
      "name": "Switch"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json['type'] }}",
                    "rightValue": "payment_success",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "payment-success-condition"
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [-5760, -200],
      "id": "payment-switch",
      "name": "Payment Switch"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json['action'] }}",
                    "rightValue": "user_expired",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "status-check-condition"
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [-5760, 160],
      "id": "status-switch",
      "name": "Status Switch"
    },
    {
      "parameters": {
        "jsCode": "// üîç VERIFICA√á√ÉO AUTOM√ÅTICA DE STATUS DO USU√ÅRIO\n// Sistema que verifica o status do usu√°rio antes de permitir acesso ao bot\n\nconst chatId = $input.item.json.chatId;\nconst message = $input.item.json.message;\nconst phone = chatId.replace('@c.us', '').replace('55', '');\n\n// üìä DADOS DOS USU√ÅRIOS (baseado no painel de controle)\n// Em produ√ß√£o, isso seria uma chamada para sua API\nconst mockUsers = {\n  // Usu√°rio em teste gr√°tis com 2 dias restantes\n  '51999887766': { \n    status: 'Teste Gr√°tis', \n    daysRemaining: 2, \n    registrationDate: '22/12/2024',\n    name: 'Maria Silva Santos'\n  },\n  // Usu√°rio expirado\n  '51988776655': { \n    status: 'Expirado', \n    daysRemaining: 0, \n    registrationDate: '19/12/2024',\n    name: 'Jo√£o Carlos Oliveira'\n  },\n  // Usu√°rio pagante\n  '51977665544': { \n    status: 'Pagante', \n    daysRemaining: null, \n    registrationDate: '15/12/2024',\n    name: 'Ana Paula Costa'\n  },\n  // Usu√°rio teste com 1 dia restante (urgente)\n  '51966554433': {\n    status: 'Teste Gr√°tis',\n    daysRemaining: 1,\n    registrationDate: '21/12/2024',\n    name: 'Carlos Eduardo Mendes'\n  },\n  // Usu√°rio teste gr√°tis rec√©m cadastrado\n  '51955443322': {\n    status: 'Teste Gr√°tis',\n    daysRemaining: 3,\n    registrationDate: '24/12/2024',\n    name: 'Fernanda Lima'\n  }\n};\n\n// üîç Verificar status do usu√°rio\nconst userStatus = mockUsers[phone] || { \n  status: 'N√£o Cadastrado', \n  daysRemaining: 0,\n  name: 'Usu√°rio'\n};\n\n// üéØ L√ìGICA DE CONTROLE DE ACESSO\nlet botResponse = '';\nlet shouldBlock = false;\nlet allowAI = false;\n\n// ‚ùå Usu√°rio n√£o cadastrado\nif (message !== 'Cadastro conclu√≠do' && userStatus.status === 'N√£o Cadastrado') {\n  botResponse = 'üëã Ol√°! Antes de continuar, por favor, fa√ßa seu cadastro no link abaixo:\\nüîó https://cadastrofinai.netlify.app\\nAssim o FinA√≠ ser√° liberado para voc√™!';\n  shouldBlock = true;\n  allowAI = false;\n}\n// ‚è∞ Usu√°rio expirado - BLOQUEAR TUDO\nelse if (userStatus.status === 'Expirado') {\n  botResponse = '‚è∞ **Seu teste gr√°tis de 3 dias expirou!**\\n\\nPara continuar usando o FinA√≠, escolha seu plano:\\nüëâ https://cadastrofinai.netlify.app\\n\\n‚ú® **Planos dispon√≠veis:**\\nüîπ Essencial: R$ 19,90/m√™s\\nüîπ Premium: R$ 39,90/m√™s\\n\\nüí° N√£o perca o controle das suas finan√ßas!';\n  shouldBlock = true;\n  allowAI = false;\n}\n// üÜì Teste gr√°tis - Permitir com aviso\nelse if (userStatus.status === 'Teste Gr√°tis') {\n  shouldBlock = false;\n  allowAI = true;\n  // N√£o definir botResponse aqui - deixar a IA responder\n}\n// ‚úÖ Cliente pagante - Acesso total\nelse if (userStatus.status === 'Pagante') {\n  shouldBlock = false;\n  allowAI = true;\n  // N√£o definir botResponse aqui - deixar a IA responder\n}\n\n// üìù Log para debug\nconsole.log(`üì± Usu√°rio ${phone} (${userStatus.name}): Status=${userStatus.status}, Dias=${userStatus.daysRemaining}, Bloquear=${shouldBlock}`);\n\nreturn [{\n  json: {\n    ...($input.item.json),\n    userStatus: userStatus,\n    botResponse: botResponse,\n    shouldBlock: shouldBlock,\n    allowAI: allowAI,\n    phone: phone\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-5540, -560],
      "id": "status-verification",
      "name": "Status Verification"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.shouldBlock }}",
                    "rightValue": true,
                    "operator": {
                      "type": "boolean",
                      "operation": "equal"
                    },
                    "id": "block-condition"
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [-5320, -560],
      "id": "access-control-switch",
      "name": "Access Control Switch"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json['message'] }}",
        "options": {
          "systemMessage": "Voc√™ √© o FinA√≠, um assistente financeiro inteligente que conversa com os usu√°rios via WhatsApp. Sua miss√£o √© ajudar as pessoas a organizar sua vida financeira de forma clara, simples e amig√°vel.\n\n---\n\nüîê INFORMA√á√ïES DO USU√ÅRIO ATUAL:\n\n**NOME:** {{ $json.userStatus.name }}\n**STATUS:** {{ $json.userStatus.status }}\n**DIAS RESTANTES:** {{ $json.userStatus.daysRemaining }}\n\n---\n\n‚úÖ **COMPORTAMENTO POR STATUS:**\n\n**üÜì TESTE GR√ÅTIS:**\n- ‚úÖ Funcione normalmente com TODAS as fun√ß√µes do FinA√≠\n- üí° **SEMPRE mencione os dias restantes**: \"Voc√™ tem {{ $json.userStatus.daysRemaining }} dia(s) restantes do teste gr√°tis\"\n- üîî Se restam 1-2 dias, seja MAIS INSISTENTE sobre o vencimento\n- üìà Destaque o valor do servi√ßo\n- ‚ö†Ô∏è Se restar 1 dia: \"ATEN√á√ÉO: Seu teste expira amanh√£!\"\n- üéØ Incentive a convers√£o de forma natural\n\n**‚úÖ PAGANTE:**\n- üöÄ Acesso total liberado\n- üíé Ofere√ßa recursos premium\n- üéØ Seja mais prestativo e detalhado\n- üìä Ofere√ßa an√°lises avan√ßadas\n- ‚ú® Nunca mencione limita√ß√µes ou tempo\n- üèÜ Trate como cliente VIP\n- üìà Foque em valor agregado\n\n---\n\nüß† **FUN√á√ïES DO FINA√ç:**\n\n1. **Registrar entradas (receitas)**  \n   Exemplos: \"recebi 1000\", \"entrou 500 do trabalho\", \"sal√°rio 3000\"\n\n2. **Registrar sa√≠das (despesas)**  \n   Exemplos: \"gastei 200 no mercado\", \"paguei aluguel 750\", \"conta de luz 150\"\n\n3. **Mostrar saldo atual**  \n   - Baseado nas entradas e sa√≠das registradas\n   - Se n√£o houver entradas, o saldo √© R$ 0,00\n   - Nunca invente valores\n\n4. **Exibir √∫ltimas movimenta√ß√µes**\n   - Mostre hist√≥rico das √∫ltimas transa√ß√µes\n\n5. **Verificar status do plano**  \n   - Informe o status atual e tempo restante\n\n6. **Relat√≥rios e an√°lises** (destaque para pagantes)\n   - Gr√°ficos de gastos\n   - Categoriza√ß√£o\n   - Dicas personalizadas\n\n---\n\n‚úÖ **EXEMPLOS DE RESPOSTA POR STATUS:**\n\n**üÜì Teste Gr√°tis (3 dias restantes):**\n\"‚úÖ Entrada registrada: R$ 1000 ‚Äì Sal√°rio\\nüí° Voc√™ tem 3 dias restantes do teste gr√°tis! Aproveite para conhecer todos os recursos.\"\n\n**üÜì Teste Gr√°tis (2 dias restantes):**\n\"‚úÖ Sa√≠da registrada: R$ 250 ‚Äì Mercado\\nüí° Voc√™ tem 2 dias restantes do teste gr√°tis! N√£o perca o acesso ao FinA√≠.\"\n\n**üÜì Teste Gr√°tis (1 dia restante - URGENTE):**\n\"‚úÖ Sa√≠da registrada: R$ 150 ‚Äì Conta de luz\\n‚ö†Ô∏è **ATEN√á√ÉO: Seu teste expira AMANH√É!**\\nGaranta j√° seu plano: https://cadastrofinai.netlify.app\"\n\n**‚úÖ Cliente Pagante:**\n\"‚úÖ Entrada registrada: R$ 1000 ‚Äì Sal√°rio\\nüìä Seu saldo atual √© R$ 2.750,00\\nüíé Como cliente premium, posso gerar um relat√≥rio detalhado dos seus gastos por categoria! Quer que eu fa√ßa uma an√°lise?\"\n\n**üìä Saldo (Teste Gr√°tis):**\n\"üí∞ Seu saldo atual √© R$ 1.500,00\\nüí° Voc√™ tem {{ $json.userStatus.daysRemaining }} dia(s) restantes do teste gr√°tis!\"\n\n**üìä Saldo (Pagante):**\n\"üí∞ Seu saldo atual √© R$ 1.500,00\\nüèÜ Como cliente premium, voc√™ tem acesso a an√°lises avan√ßadas e relat√≥rios personalizados! Quer ver um resumo detalhado?\"\n\n---\n\n‚ö†Ô∏è **REGRAS CR√çTICAS:**\n\n1. **SEMPRE mencione tempo restante para teste gr√°tis**\n2. **SEJA MAIS INSISTENTE quando restar 1 dia**\n3. **DESTAQUE benef√≠cios dos planos pagos de forma natural**\n4. **TRATE pagantes como VIP com recursos exclusivos**\n5. **MANTENHA tom amig√°vel mas informativo**\n6. **NUNCA invente valores de saldo**\n7. **SEMPRE responda de forma √∫til e clara**\n8. **USE o nome do usu√°rio quando apropriado**\n\n---\n\nüéØ **OBJETIVO:**\nSer um assistente financeiro √∫til e inteligente, sempre consciente do status do usu√°rio e incentivando a convers√£o para planos pagos de forma natural e n√£o invasiva.\n\nVoc√™ est√° pronto para atender {{ $json.userStatus.name }} com intelig√™ncia e controle de acesso!"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [-5100, -400],
      "id": "ddc1474c-8910-4c2f-93fd-4ada9fed3368",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "modelName": "models/gemini-2.0-flash",
        "options": {
          "temperature": 0.1
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [-5080, -260],
      "id": "f59df24e-9381-4966-b51e-8f5468730569",
      "name": "Google Gemini Chat Model",
      "credentials": {
        "googlePalmApi": {
          "id": "B4d4E6bRny3Fr2Yu",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Edit Fields').item.json['chatId'] }}",
        "sessionTTL": 1000000000000,
        "contextWindowLength": 10
      },
      "type": "@n8n/n8n-nodes-langchain.memoryRedisChat",
      "typeVersion": 1.5,
      "position": [-4980, -260],
      "id": "20f86103-4837-46e9-8560-8780e557eac3",
      "name": "Redis Chat Memory",
      "credentials": {
        "redis": {
          "id": "oXRxIfT7Yqhc75F3",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "resource": "Chatting",
        "operation": "Send Seen",
        "session": "={{ $('Edit Fields').item.json.session }}",
        "chatId": "={{ $('Edit Fields').item.json['chatId'] }}",
        "messageId": "={{ $('Edit Fields').item.json['payload_id'] }}",
        "requestOptions": {}
      },
      "type": "n8n-nodes-waha.WAHA",
      "typeVersion": 202411,
      "position": [-4880, -400],
      "id": "0bbc7bec-2b78-48e6-b3a0-ebe1b6c92ae9",
      "name": "WAHA",
      "credentials": {
        "wahaApi": {
          "id": "v70jRdZkrdyOoBh2",
          "name": "WAHA account"
        }
      }
    },
    {
      "parameters": {
        "resource": "Chatting",
        "operation": "Send Text",
        "session": "={{ $('Edit Fields').item.json.session }}",
        "chatId": "={{ $('Edit Fields').item.json['chatId'] }}",
        "text": "={{ $('AI Agent').item.json.output }}",
        "requestOptions": {}
      },
      "type": "n8n-nodes-waha.WAHA",
      "typeVersion": 202411,
      "position": [-4660, -400],
      "id": "25c21dc3-95db-487a-8145-ea4a9def263e",
      "name": "WAHA1",
      "credentials": {
        "wahaApi": {
          "id": "v70jRdZkrdyOoBh2",
          "name": "WAHA account"
        }
      }
    },
    {
      "parameters": {
        "resource": "Chatting",
        "operation": "Send Text",
        "session": "={{ $('Edit Fields').item.json.session }}",
        "chatId": "={{ $('Edit Fields').item.json['chatId'] }}",
        "text": "={{ $('Status Verification').item.json.botResponse }}",
        "requestOptions": {}
      },
      "type": "n8n-nodes-waha.WAHA",
      "typeVersion": 202411,
      "position": [-5100, -560],
      "id": "blocked-response-waha",
      "name": "Blocked Response WAHA",
      "credentials": {
        "wahaApi": {
          "id": "v70jRdZkrdyOoBh2",
          "name": "WAHA account"
        }
      }
    },
    {
      "parameters": {
        "resource": "Chatting",
        "operation": "Send Text",
        "session": "default",
        "chatId": "={{ $('Edit Payment Fields').item.json.client.phone }}@c.us",
        "text": "={{ $('Edit Payment Fields').item.json.message }}",
        "requestOptions": {}
      },
      "type": "n8n-nodes-waha.WAHA",
      "typeVersion": 202411,
      "position": [-5540, -200],
      "id": "payment-notification-waha",
      "name": "Payment Notification WAHA",
      "credentials": {
        "wahaApi": {
          "id": "v70jRdZkrdyOoBh2",
          "name": "WAHA account"
        }
      }
    },
    {
      "parameters": {
        "resource": "Chatting",
        "operation": "Send Text",
        "session": "default",
        "chatId": "={{ $('Edit Status Fields').item.json.phone }}@c.us",
        "text": "‚è∞ *Seu teste gr√°tis de 3 dias expirou!*\\n\\nPara continuar usando o FinA√≠, escolha seu plano:\\nüëâ https://cadastrofinai.netlify.app\\n\\n‚ú® *Planos dispon√≠veis:*\\nüîπ Essencial: R$ 19,90/m√™s\\nüîπ Premium: R$ 39,90/m√™s\\n\\nüí° N√£o perca o controle das suas finan√ßas!",
        "requestOptions": {}
      },
      "type": "n8n-nodes-waha.WAHA",
      "typeVersion": 202411,
      "position": [-5540, 160],
      "id": "expiry-notification-waha",
      "name": "Expiry Notification WAHA",
      "credentials": {
        "wahaApi": {
          "id": "v70jRdZkrdyOoBh2",
          "name": "WAHA account"
        }
      }
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours",
              "hoursInterval": 6
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [-6300, 520],
      "id": "schedule-status-check",
      "name": "Schedule Status Check (6h)"
    },
    {
      "parameters": {
        "jsCode": "// üîç VERIFICA√á√ÉO AUTOM√ÅTICA DE USU√ÅRIOS EXPIRADOS\n// Este c√≥digo verifica usu√°rios que expiraram e precisam de notifica√ß√£o\n// Baseado nos dados reais do painel de controle\n\nconst today = new Date();\n\n// üìä Simular usu√°rios que expiraram (baseado no painel)\n// Em produ√ß√£o, isso seria uma consulta ao banco de dados\nconst expiredUsers = [\n  {\n    phone: \"51988776655\",\n    name: \"Jo√£o Carlos Oliveira\",\n    status: \"Expirado\",\n    registrationDate: \"19/12/2024\",\n    email: \"joao.carlos@email.com\",\n    daysExpired: 3\n  },\n  {\n    phone: \"51966554433\",\n    name: \"Carlos Eduardo Mendes\", \n    status: \"Teste Gr√°tis\",\n    registrationDate: \"20/12/2024\",\n    email: \"carlos.mendes@email.com\",\n    daysRemaining: 0, // Expira hoje\n    willExpire: true\n  }\n];\n\n// üìù Log da verifica√ß√£o\nconst timestamp = new Date().toLocaleString('pt-BR');\nconsole.log(`üîç [${timestamp}] Verifica√ß√£o autom√°tica executada`);\nconsole.log(`üìä ${expiredUsers.length} usu√°rio(s) precisam de notifica√ß√£o`);\nconsole.log(`‚è∞ Pr√≥xima verifica√ß√£o em 6 horas`);\n\n// Filtrar apenas usu√°rios que realmente precisam de notifica√ß√£o\nconst usersToNotify = expiredUsers.filter(user => \n  user.status === 'Expirado' || user.willExpire\n);\n\nconsole.log(`üì± ${usersToNotify.length} notifica√ß√£o(√µes) ser√£o enviada(s)`);\n\n// Retornar dados dos usu√°rios para notifica√ß√£o\nreturn [{\n  json: {\n    expiredUsers: usersToNotify,\n    count: usersToNotify.length,\n    timestamp: new Date().toISOString(),\n    message: `Verifica√ß√£o autom√°tica: ${usersToNotify.length} usu√°rios precisam de notifica√ß√£o`,\n    nextCheck: \"6 horas\",\n    details: {\n      totalChecked: expiredUsers.length,\n      willNotify: usersToNotify.length,\n      checkTime: timestamp\n    }\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-6040, 520],
      "id": "check-expired-users-simulation",
      "name": "Check Expired Users"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "expired-users",
              "name": "expiredUsers",
              "value": "={{ $json.expiredUsers }}",
              "type": "object"
            },
            {
              "id": "expired-count",
              "name": "count",
              "value": "={{ $json.count }}",
              "type": "number"
            },
            {
              "id": "check-details",
              "name": "details",
              "value": "={{ $json.details }}",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [-5760, 520],
      "id": "process-expired-users",
      "name": "Process Expired Users"
    },
    {
      "parameters": {
        "batchSize": 1,
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [-5540, 520],
      "id": "split-expired-users",
      "name": "Split Expired Users"
    },
    {
      "parameters": {
        "resource": "Chatting",
        "operation": "Send Text",
        "session": "default",
        "chatId": "={{ $json.phone }}@c.us",
        "text": "‚è∞ *Seu teste gr√°tis de 3 dias expirou!*\\n\\nOl√° {{ $json.name }}, para continuar usando o FinA√≠, escolha seu plano:\\nüëâ https://cadastrofinai.netlify.app\\n\\n‚ú® *Planos dispon√≠veis:*\\nüîπ Essencial: R$ 19,90/m√™s\\nüîπ Premium: R$ 39,90/m√™s\\n\\nüí° N√£o perca o controle das suas finan√ßas!\\n\\nüìä Mantenha sua organiza√ß√£o financeira em dia!",
        "requestOptions": {}
      },
      "type": "n8n-nodes-waha.WAHA",
      "typeVersion": 202411,
      "position": [-5320, 520],
      "id": "batch-expiry-notification",
      "name": "Batch Expiry Notification",
      "credentials": {
        "wahaApi": {
          "id": "v70jRdZkrdyOoBh2",
          "name": "WAHA account"
        }
      }
    }
  ],
  "connections": {
    "Webhook Principal": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook Pagamentos": {
      "main": [
        [
          {
            "node": "Edit Payment Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook Verifica√ß√£o Status": {
      "main": [
        [
          {
            "node": "Edit Status Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Payment Fields": {
      "main": [
        [
          {
            "node": "Payment Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Status Fields": {
      "main": [
        [
          {
            "node": "Status Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "Status Verification",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Payment Switch": {
      "main": [
        [
          {
            "node": "Payment Notification WAHA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Status Switch": {
      "main": [
        [
          {
            "node": "Expiry Notification WAHA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Status Verification": {
      "main": [
        [
          {
            "node": "Access Control Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Access Control Switch": {
      "main": [
        [
          {
            "node": "Blocked Response WAHA",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Redis Chat Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "WAHA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "WAHA": {
      "main": [
        [
          {
            "node": "WAHA1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Schedule Status Check (6h)": {
      "main": [
        [
          {
            "node": "Check Expired Users",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Expired Users": {
      "main": [
        [
          {
            "node": "Process Expired Users",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Expired Users": {
      "main": [
        [
          {
            "node": "Split Expired Users",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Expired Users": {
      "main": [
        [
          {
            "node": "Batch Expiry Notification",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "id": "finai-bot-completo-final",
  "tags": ["finai", "whatsapp", "bot", "status-control", "complete"]
}